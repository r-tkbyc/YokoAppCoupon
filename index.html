<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Text Formatter v1.1.3 - 2026-01-21 -->
  <meta name="app-version" content="v1.1.3">

  <title>YokoAppCoupon流し込みツール</title>
  <style>
  :root { --gap: 8px; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, sans-serif; margin: 0; background: #0b0f14; color: #e6edf3; }
  header { padding: 10px 14px; border-bottom: 1px solid #22303e; background: #0f1620; }
  h1 { margin: 0; font-size: 18px; font-weight: 700; }
  main { padding: 12px; max-width: 1200px; margin: 0 auto; }

  .set { display: flex; flex-direction: column; gap: var(--gap); margin-top: 14px; background: #0f1620; border: 1px solid #22303e; border-radius: 8px; padding: 8px; }
  .set-head { display: flex; align-items: center; justify-content: space-between; gap: 6px; }
  .set-title { margin: 0; font-size: 13px; color: #c9d6e2; font-weight: 700; }
  .actions { display: flex; gap: 6px; align-items: center; }

  .row { display: grid; grid-template-columns: 1fr; gap: var(--gap); }
  @media (min-width: 960px) { .row { grid-template-columns: 1fr 1fr; } }

  .stack { display:flex; flex-direction:column; gap: var(--gap); }

  .panel { background: #0b121a; border: 1px solid #22303e; border-radius: 6px; padding: 8px; display: flex; flex-direction: column; gap: 6px; }
  .panel h2 { margin: 0 0 2px; font-size: 12px; font-weight: 700; color: #9fb3c8; }

  textarea { width: 100%; min-height: 60px; resize: vertical; background: #0b121a; color: #e6edf3; border: 1px solid #22303e; border-radius: 6px; padding: 10px; line-height: 1.45; font-size: 13px; }
  textarea[readonly] { opacity: .95; }

  button { cursor: pointer; border: 1px solid #2a3a4b; background: #132032; color: #e6edf3; border-radius: 6px; padding: 6px 10px; font-size: 12px; }
  button:hover { background: #18283d; }
  button:active { transform: translateY(1px); }
  .primary { background: #2155cd; border-color: #2155cd; }

  .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: rgba(20,30,45,.95); border: 1px solid #2a3a4b; padding: 10px 14px; border-radius: 10px; color: #e6edf3; font-size: 13px; opacity: 0; pointer-events: none; transition: opacity .25s ease; }
  .toast.show { opacity: 1; }

  /* === Unity-like compact theme overrides (CSS-only) === */
  :root { --gap: 6px; }
  body { background:#383838; color:#dcdcdc; }
  header { background:#383838; border-bottom:1px solid #222; padding:8px 12px; }
  h1 { font-size:14px; font-weight:600; color:#dcdcdc; }
  main { padding:10px; }
  .set { background:#383838; border:1px solid #222; border-radius:2px; padding:6px; margin-top:10px; }
  .set-title { font-size:12px; color:#e0e0e0; }
  .actions { gap:5px; }
  .panel { background:#383838; border:1px solid #222; border-radius:2px; padding:6px; gap:6px; }
  .panel h2 { font-size:11px; color:#bfbfbf; margin:0 0 2px; font-weight:600; }
  textarea { background:#2a2a2a; border:1px solid #3b3b3b; border-radius:2px; color:#e3e3e3; padding:8px; line-height:1.4; font-size:12px; }
  textarea[readonly]{opacity:.98;}
  textarea:focus, select:focus, input:focus, button:focus { outline:1px solid #2a81fb; outline-offset:0; box-shadow:0 0 0 1px #2a81fb inset; }
  button { background:#585858; border:1px solid #111111; color:#eaeaea; border-radius:2px; padding:4px 8px; font-size:12px; }
  button:hover { background:#4a4a4a; }
  button:active { background:#5a5a5a; transform:none; }
  .primary { background:#585858; border-color:#222; color:#ffffff; }
  .toast { background:rgba(46,46,46,.98); border:1px solid #3b3b3b; color:#dedede; font-size:12px; }

  :root { --gap: 4px; }
  header { padding: 6px 10px; }
  .set { padding: 4px; margin-top: 8px; }
  .set-title { font-size: 11.5px; }
  .actions { gap: 4px; }
  .panel { padding: 4px; gap: 4px; }
  .panel h2 { font-size: 11px; margin: 0 0 1px; }
  textarea { padding: 6px; line-height: 1.35; font-size: 12px; min-height: 60px; }
  button { padding: 3px 8px; font-size: 11px; }
  .toast { font-size: 11px; padding: 8px 10px; }

  body { font-size: 12px; }
  h1 { font-size: 13px; }
  .set-title { font-size: 11px; }
  .panel h2 { font-size: 10px; }
  textarea { font-size: 11px; line-height: 1.3; }
  button { font-size: 10px; padding: 2px 7px; }
  .toast { font-size: 10.5px; padding: 6px 8px; }

  :root { --btn-h: 20px; }
  button { height: var(--btn-h); padding: 0 8px !important; line-height: calc(var(--btn-h) - 2px); }
  header { display:flex; align-items:center; justify-content:space-between; }
  .ver-badge { font-size:10px; background:#3d3d3d; border:1px solid #565656; color:#eaeaea;
    border-radius:2px; padding:0 6px; line-height:18px; height:18px; white-space:nowrap; }

  .quad-row{
    display:grid;
    grid-template-columns: 1fr;
    gap: var(--gap);
  }
  @media (min-width: 960px){
    .quad-row{
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }
  }

  input, select{
    width: 100%;
    height: var(--btn-h);
    background:#585858;
    border:1px solid #111111;
    color:#eaeaea;
    border-radius:2px;
    padding: 0 8px;
    font-size: 10px;
    line-height: calc(var(--btn-h) - 2px);
    appearance: none;
  }
  select{
    padding-right: 22px;
    background-image:
      linear-gradient(45deg, transparent 50%, #eaeaea 50%),
      linear-gradient(135deg, #eaeaea 50%, transparent 50%);
    background-position:
      calc(100% - 14px) calc(50% - 2px),
      calc(100% - 9px) calc(50% - 2px);
    background-size: 5px 5px, 5px 5px;
    background-repeat: no-repeat;
  }
  input[type="number"]{ appearance: textfield; }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
  </style>
</head>

<body>
  <header>
    <h1>YokoAppCoupon流し込みツール</h1>
    <button id="ver" class="ver-badge"></button>
  </header>

  <main>
    <!-- タイトル / 管理名称 -->
    <section class="set" data-set="title">
      <div class="set-head">
        <h2 class="set-title">タイトル / 管理名称</h2>
        <div class="actions">
          <!-- ※toCMSボタンは拡張側（koma_inject）でここに挿入する想定 -->
          <button class="btn-convert primary" title="変換（Ctrl/Cmd+Enter）">&nbsp;変換&nbsp;</button>
        </div>
      </div>

      <div class="row">
        <section class="panel">
          <h2>入力</h2>
          <textarea class="input" placeholder="ここにテキストをペースト"></textarea>
        </section>

        <div class="stack">
          <section class="panel">
            <h2>出力（タイトル）</h2>
            <textarea class="output-title" placeholder="ここに整形結果が表示されます" readonly></textarea>
          </section>

          <section class="panel">
            <h2>出力（管理名称）</h2>
            <textarea class="output-admin" placeholder="ここに整形結果が表示されます" readonly></textarea>
          </section>
        </div>
      </div>
    </section>

    <!-- メタ -->
    <section class="set" data-set="meta">
      <div class="set-head">
        <h2 class="set-title">部門 / 先着人数 / 表示グループ / カテゴリ</h2>
        <div class="actions"></div>
      </div>

      <div class="quad-row">
        <section class="panel" data-field="division">
          <h2>部門</h2>
          <select id="division">
            <option value="" selected>選択してください</option>
            <option value="①">①</option>
            <option value="②">②</option>
            <option value="③">③</option>
            <option value="④">④</option>
            <option value="⑤">⑤</option>
            <option value="呉服">呉服</option>
            <option value="美術">美術</option>
          </select>
        </section>

        <section class="panel" data-field="first-come">
          <h2>先着人数</h2>
          <input id="firstCome" type="number" min="0" step="1" placeholder="例：30">
        </section>

        <section class="panel" data-field="display-group">
          <h2>表示グループ</h2>
          <select id="displayGroup">
            <option value="" selected>選択してください</option>
            <option value="ビューティー">ビューティー</option>
            <option value="キャンペーン">キャンペーン</option>
            <option value="催・イベント">催・イベント</option>
            <option value="ファッション">ファッション</option>
            <option value="グルメ">グルメ</option>
            <option value="キッズ">キッズ</option>
            <option value="ライフスタイル">ライフスタイル</option>
          </select>
        </section>

        <section class="panel" data-field="category">
          <h2>カテゴリ</h2>
          <select id="category">
            <option value="" selected>選択してください</option>
            <option value="アプリクーポン">アプリクーポン</option>
            <option value="アプリ会員様限定ポイントアップ">アプリ会員様限定ポイントアップ</option>
          </select>
        </section>
      </div>
    </section>

    <!-- フロア・売場 / ブランド名 -->
    <section class="set" data-set="floor-brand">
      <div class="set-head">
        <h2 class="set-title">フロア・売場 / ブランド名</h2>
        <div class="actions"></div>
      </div>

      <!-- 1行目：フロア・売場 -->
      <div class="row">
        <section class="panel">
          <h2>入力（フロア・売場）</h2>
          <textarea class="input-floor" placeholder="1階 化粧品"></textarea>
        </section>

        <section class="panel">
          <h2>出力（ブランド入居フロア）</h2>
          <textarea class="output-floor" placeholder="ここに整形結果が表示されます" readonly></textarea>
        </section>
      </div>

      <!-- 2行目：ブランド名 -->
      <div class="row">
        <section class="panel">
          <h2>入力（ブランド名）</h2>
          <textarea class="input-brand" placeholder="エスト"></textarea>
        </section>

        <section class="panel">
          <h2>出力（ブランド名）</h2>
          <textarea class="output-brand" placeholder="ここに整形結果が表示されます" readonly></textarea>
        </section>
      </div>
    </section>

    <!-- ご利用条件 -->
    <section class="set" data-set="terms">
      <div class="set-head">
        <h2 class="set-title">ご利用条件</h2>
        <div class="actions"></div>
      </div>

      <div class="row">
        <section class="panel">
          <h2>入力</h2>
          <textarea class="input-terms" placeholder="ここにテキストをペースト"></textarea>
        </section>

        <section class="panel">
          <h2>出力</h2>
          <textarea class="output-terms" placeholder="ここに整形結果が表示されます" readonly></textarea>
        </section>
      </div>
    </section>

    <!-- 注意事項 -->
    <section class="set" data-set="notes">
      <div class="set-head">
        <h2 class="set-title">注意事項</h2>
        <div class="actions"></div>
      </div>

      <div class="row">
        <section class="panel">
          <h2>入力</h2>
          <textarea class="input-notes" placeholder="ここにテキストをペースト"></textarea>
        </section>

        <section class="panel">
          <h2>出力</h2>
          <textarea class="output-notes" placeholder="ここに整形結果が表示されます" readonly></textarea>
        </section>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script>
  const APP_VERSION = "v1.1.3";
  const APP_BUILD = "2026-01-21";
  const PRICE_SPACE_RULE_ENABLED = false;

  document.addEventListener("DOMContentLoaded", () => {
    const el = document.getElementById("ver");
    if (el) el.textContent = `${APP_VERSION} (${APP_BUILD})`;
  });

  // =============================
  //  ルール適用パイプライン（全体）
  // =============================
  const rulesGlobal = [];

  rulesGlobal.push(function urlProtect(s){
    const urlRegex = /(https?:\/\/[!-~]+)/g;
    const bucket = [];
    const out = String(s||'').replace(urlRegex, (m) => {
      const half = m
        .replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0))
        .replace(/[！-～]/g,       ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0))
        .replace(/[‐―－ー‒–—−]/g, '-');
      const key = `⟦URL${bucket.length}⟧`;
      bucket.push(half);
      return key;
    });
    return { text: out, ctx: { urls: bucket } };
  });

  rulesGlobal.push(function siCompatUnits(s){
    return String(s||'').replace(/\u339D/g, 'cm')
                        .replace(/\u3396/g, 'ml')
                        .replace(/\u339C/g, 'mm');
  });

  rulesGlobal.push(function fullwidthBracketsAndWave(s){
    return String(s||'')
      .replace(/\[/g, '［')
      .replace(/\]/g, '］')
      .replace(/[\u007E\u301C]/g, '～')
      .replace(/→/g, '～');
  });

  rulesGlobal.push(function lexicalReplacements(s){
    return String(s || '')
      .replace(/POPUPSTORE/g, 'POP UP STORE')
      .replace(/POPUPSHOP/g, 'POP UP SHOP')
      .replace(/POPUP/g, 'POP UP')
      .replace(/是非/g, 'ぜひ')
      .replace(/くださいませ/g, 'ください')
      .replace(/お買い上げ/g, 'お買上げ')
      .replace(/お買いあげ/g, 'お買上げ')
      .replace(/致します/g, 'いたします')
      .replace(/ラインナップ/g, 'ラインアップ')
      .replace(/髙島屋/g, '高島屋');
  });

  rulesGlobal.push(function widthNorm(s){
    const toHalfAlnum = x => x.replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
    const toHalfDigits= x => x.replace(/[０-９]/g,           ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
    const toFullWidthSymbols = x => x.replace(/[\x21-\x7E]/g, ch => {
      if (/[A-Za-z0-9]/.test(ch)) return ch;
      if (ch === ' ') return ch;
      return String.fromCharCode(ch.charCodeAt(0) + 0xFEE0);
    });
    let body = toHalfAlnum(s);
    body = toFullWidthSymbols(body);
    body = toHalfDigits(body);
    body = body
      .replace(/\(/g,'（').replace(/\)/g,'）')
      .replace(/\[/g,'［').replace(/\]/g,'］')
      .replace(/\{/g,'｛').replace(/\}/g,'｝')
      .replace(/</g,'＜').replace(/>/g,'＞')
      .replace(/＜/g,'〈').replace(/＞/g,'〉')
      .replace(/≪/g,'《').replace(/≫/g,'》')
      .replace(/【/g,'〔').replace(/】/g,'〕')
      .replace(/\*/g,'※').replace(/＊/g,'※');
    body = body.replace(/[A-Za-z0-9０-９]+[\p{P}\p{S}]+(?=[A-Za-z0-9０-９]+)/gu, seg =>
      seg.replace(/[！-～]/g, ch => {
        const keep = '（）［］｛｝「」『』《》〔〕〈〉';
        if (keep.includes(ch)) return ch;
        return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0);
      }).replace(/[‐―－ー‒–—−]/g, '-')
    );
    return body;
  });

  rulesGlobal.push(function fixTelColon(s){
    return String(s || '').replace(/\bTEL[:：]/g, 'TEL：');
  });

  rulesGlobal.push(function spaceBreak(s){
    return String(s||'')
      .replace(/[ 　]+/g,' ')
      .replace(/(\r?\n){3,}/g,'\n\n');
  });

  rulesGlobal.push(function ensureZenkakuSpaceBeforePrice(s){
    if (!PRICE_SPACE_RULE_ENABLED) return s;
    const str = String(s || '');
    const priceRe = /([ 　]*)(\d{1,3}(?:,\d{3})+|\d+)([ 　]*円)/g;

    return str.replace(priceRe, (match, ws, num, yenPart, offset) => {
      const prev = str.slice(0, offset);
      const next = str.slice(offset + match.length);

      if (prev.endsWith('税込') && next.startsWith('以上')) return match;

      const prevChar = prev.slice(-1);
      const atLineStart = offset === 0 || prevChar === '\n' || prevChar === '\r';
      if (atLineStart) return `${num}${yenPart}`;

      return `　${num}${yenPart}`;
    });
  });

  rulesGlobal.push(function urlRestore(s, ctx){
    return String(s||'').replace(/⟦URL(\d+)⟧/g, (_, i) => (ctx.urls||[])[Number(i)] ?? '');
  });

  function transform(text){
    let ctx = {};
    let current = String(text||'');
    for (const rule of rulesGlobal){
      const r = rule(current, ctx);
      if (typeof r === 'string'){ current = r; }
      else if (r && typeof r === 'object' && 'text' in r){
        current = r.text;
        ctx = { ...(ctx||{}), ...(r.ctx||{}) };
      }
    }
    return current;
  }

  const toastEl = document.getElementById('toast');
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove('show'), 1200);
  }

  // =============================
  //  変換（タイトルブロックのボタンで全体を更新）
  // =============================
  (function(){
    const titleSet = document.querySelector('.set[data-set="title"]');
    if(!titleSet) return;

    const input  = titleSet.querySelector('.input');
    const outTitle = titleSet.querySelector('.output-title');
    const outAdmin = titleSet.querySelector('.output-admin');
    const btnConvert = titleSet.querySelector('.btn-convert');

    // meta
    const divisionEl = document.getElementById('division');
    const firstComeEl = document.getElementById('firstCome');

    // floor/brand
    const floorSet = document.querySelector('.set[data-set="floor-brand"]');
    const inFloor   = floorSet?.querySelector('.input-floor');
    const outFloor  = floorSet?.querySelector('.output-floor');
    const inBrand   = floorSet?.querySelector('.input-brand');
    const outBrand  = floorSet?.querySelector('.output-brand');

    // terms / notes
    const termsSet = document.querySelector('.set[data-set="terms"]');
    const inTerms  = termsSet?.querySelector('.input-terms');
    const outTerms = termsSet?.querySelector('.output-terms');

    const notesSet = document.querySelector('.set[data-set="notes"]');
    const inNotes  = notesSet?.querySelector('.input-notes');
    const outNotes = notesSet?.querySelector('.output-notes');

    function buildTitleResult(baseText){
      let t = transform(baseText).trim();

      // 先着人数（数値が入ってる時だけ）
      const nRaw = (firstComeEl?.value ?? '').toString().trim();
      const n = nRaw.replace(/[^\d]/g, '');
      if (n) t += `※先着${n}名様`;

      return t;
    }

    function parseFloorAndPlace(floorText){
      const normalized = transform(floorText).replace(/[ 　]+/g,' ').trim();
      if (!normalized) return { floor: '', place: '' };

      // 先頭に「地下N階 / N階 / 屋上」が来る想定
      const m = normalized.match(/^(地下\s*\d+階|地下\d+階|\d+階|屋上)\s*(.*)$/);
      if (!m) return { floor: '', place: normalized };

      const floor = m[1].replace(/[ 　]+/g,''); // 地下 1階 → 地下1階
      const place = (m[2] || '').trim();
      return { floor, place };
    }

    function buildBrandResult(place, brandText){
      const b = transform(brandText).trim();
      if (b){
        if (place) return `${place}［${b}］`;
        return `［${b}］`;
      }
      // ブランド未入力なら「売場」だけ（例：健康の庭）
      return place || '';
    }

    function onConvert(){
      // タイトル/管理名称
      const src = input.value || '';
      const titleResult = buildTitleResult(src);

      // 部門（未選択なら付けない）
      const div = (divisionEl?.value ?? '').toString().trim();

      if (outTitle) outTitle.value = titleResult;
      if (outAdmin) outAdmin.value = (div ? (div + titleResult) : titleResult);

      // フロア・売場 / ブランド名
      if (inFloor && outFloor && outBrand){
        const { floor, place } = parseFloorAndPlace(inFloor.value || '');
        outFloor.value = floor;

        const brandText = inBrand ? (inBrand.value || '') : '';
        outBrand.value = buildBrandResult(place, brandText);
      }

      // ご利用条件 / 注意事項（独自ルールなし：transformのみ）
      if (outTerms && inTerms) outTerms.value = transform(inTerms.value || '').replace(/[ \t]+$/gm,'').trimEnd();
      if (outNotes && inNotes) outNotes.value = transform(inNotes.value || '').replace(/[ \t]+$/gm,'').trimEnd();

      toast('変換しました');
    }

    if(btnConvert) btnConvert.addEventListener('click', onConvert);
    titleSet.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){
        e.preventDefault();
        onConvert();
      }
    });
  })();

  // 右上バージョン＝クリア（全部クリア）
  (function(){
    function clearAll(){
      var nodes = document.querySelectorAll('input, textarea, select');
      nodes.forEach(function(el){
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
        else el.value = '';
      });
      toast('クリアしました');
    }
    var vb = document.getElementById('ver');
    if (vb) vb.addEventListener('click', function(e){ e.preventDefault(); clearAll(); });
  })();
  </script>
</body>
</html>
